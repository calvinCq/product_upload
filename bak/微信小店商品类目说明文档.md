# 微信视频号小店商品类目API说明文档

## 1. 概述

本文档基于微信官方开发者文档，详细介绍微信视频号小店商品类目API的获取方法、数据结构和使用规范。商品类目是视频号小店商品上传的必填字段，正确选择商品类目对于商品的分类展示、合规性和搜索排名至关重要。

## 2. 官方标准类目API详解

### 2.1 API基本信息

**接口名称**：getallcategory
**API路径**：`/channels/ec/category/all`
**调用方式**：HTTPS GET
**官方文档**：[获取所有类目](https://developers.weixin.qq.com/doc/store/shop/API/channels-shop-category/api_getallcategory.html)

**重要说明**：
- 接口应在服务器端调用，不可在前端（小程序、网页、APP等）直接调用
- 此接口支持获取全部类目信息、类目的资质信息、商品资质信息
- 接口新增`cats_v2`字段支持新类目树，推荐优先使用新版数据结构

### 2.2 调用方式

#### HTTPS 调用
```
GET https://api.weixin.qq.com/channels/ec/category/all?access_token=ACCESS_TOKEN
```

#### 云调用
调用方法：`channels.ec.category.all`
出入参和 HTTPS 调用相同

#### 第三方调用
本接口支持第三方平台代微信小店商家调用，需要相应权限集授权。
- 权限集 id: 85、129
- 使用 `authorizer_access_token` 进行调用

### 2.3 请求参数

**Query String 参数**：

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| access_token | string | 是 | 接口调用凭证，可使用 access_token（微信小店商家）、authorizer_access_token（服务商） |

**请求体**：无需请求体参数

### 2.4 access_token获取方式

所有类目API都需要通过access_token进行授权访问。在WeChatShopAPIClient类中，access_token的获取和管理已完全集成到API请求流程中：

1. 初始化时传入appid和appsecret
2. 每次API调用前，_api_request方法会自动检查access_token是否有效
3. 如果access_token不存在或已过期，会自动调用微信的access_token获取接口刷新
4. 所有类目获取方法(get_category, get_all_category, get_channels_category)都会自动使用有效的access_token

### 2.4 返回参数

**返回数据结构**：

```json
{
  "errcode": 0,
  "errmsg": "ok",
  "cats": [
    {
      "cat_and_qua": [
        {
          "cat": {
            "cat_id": 1,
            "name": "类目名称",
            "f_cat_id": 0,
            "level": 1
          },
          "qua": {
            "qua_id": 1,
            "need_to_apply": false,
            "tips": "资质说明",
            "mandatory": false,
            "cert_group_list": [...]
          },
          "product_qua_list": [...],
          "brand_qua": {...},
          "is_confidence_require_bad_must_pay": false
        }
      ]
    }
  ],
  "cats_v2": [
    {
      "cat_and_qua": [
        {
          "cat": {
            "cat_id": 1,
            "name": "类目名称",
            "f_cat_id": 0,
            "level": 1,
            "leaf": false
          },
          "qua": {...},
          "product_qua_list": [...],
          "brand_qua": {...},
          "is_confidence_require_bad_must_pay": false
        }
      ]
    }
  ]
}
```

**关键字段说明**：

| 字段名 | 类型 | 说明 |
|-------|------|------|
| errcode | number | 错误码，0表示成功 |
| errmsg | string | 错误信息 |
| cats | array | 旧版类目信息数组 |
| cats_v2 | array | 新版类目信息数组（推荐使用） |

### 2.5 类目详情字段说明

**cat 对象（类目详情）**：

| 字段名 | 类型 | 说明 |
|-------|------|------|
| cat_id | number | 类目ID |
| name | string | 类目名称 |
| f_cat_id | number | 父类目ID |
| level | number | 类目等级 |
| leaf | boolean | 是否为叶子类目（仅新版cats_v2中包含） |

**qua 对象（资质详情）**：

| 字段名 | 类型 | 说明 |
|-------|------|------|
| qua_id | number | 资质ID |
| need_to_apply | boolean | 该类目是否需要申请才能用 |
| tips | string | 资质信息说明 |
| mandatory | boolean | 该类目申请时是否必须提交资质 |
| cert_group_list | array | 证照信息列表 |

## 3. 代码实现

### 3.1 初始化API客户端

```python
# 初始化微信小店API客户端
from wechat_shop_api import WeChatShopAPIClient

# 创建API客户端实例
# 重要：必须提供有效的appid和appsecret以获取access_token
client = WeChatShopAPIClient(
    appid="your_appid_here",  # 替换为实际的AppID
    appsecret="your_appsecret_here"  # 替换为实际的AppSecret
)

# 客户端内部会自动管理access_token的获取和刷新
# 无需手动设置access_token
```

### 3.2 API调用实现

在`WeChatShopAPIClient`类中实现官方标准类目API调用：

```python
def get_all_category(self):
    """
    获取所有视频号小店类目信息（官方标准接口）
    根据文档：https://developers.weixin.qq.com/doc/store/shop/API/channels-shop-category/api_getallcategory.html
    支持获取全部类目信息、资质信息、商品资质信息
    
    :return: 类目数据结果
    """
    try:
        # 发送请求 - 官方文档显示这个接口不需要请求体参数
        # 使用GET请求，参数通过query string传递access_token
        path = self.API_PATHS["get_all_category"]
        response = self._api_request(path, method="GET")
        
        # 记录操作历史
        self._record_operation("get_all_category", "success", path)
        
        return {
            "success": True,
            "data": response
        }
        
    except Exception as e:
        # 记录错误
        error_msg = f"获取视频号小店类目失败: {str(e)}"
        self._record_operation("get_all_category", "error", str(e))
        return {
            "success": False,
            "error": error_msg
        }
```

### 3.2 数据解析示例

解析官方返回的类目数据，提取结构化信息：

```python
def parse_official_category_data(official_data):
    """
    解析官方返回的标准类目数据
    :param official_data: 官方API返回的原始数据
    :return: 解析后的类目列表和统计信息
    """
    categories = []
    stats = {
        "total": 0,
        "levels": {},
        "leaf_count": 0,
        "has_v2": False
    }
    
    # 优先使用cats_v2（新版数据）
    if "cats_v2" in official_data and official_data["cats_v2"]:
        stats["has_v2"] = True
        for cat_item in official_data["cats_v2"]:
            if "cat_and_qua" in cat_item:
                for cat_info in cat_item["cat_and_qua"]:
                    if "cat" in cat_info:
                        cat = cat_info["cat"]
                        cat_id = cat.get("cat_id")
                        name = cat.get("name")
                        parent_id = cat.get("f_cat_id", 0)
                        level = cat.get("level", 1)
                        is_leaf = cat.get("leaf", False)
                        
                        categories.append({
                            "id": cat_id,
                            "name": name,
                            "parent_id": parent_id,
                            "level": level,
                            "leaf": is_leaf,
                            "source": "v2"
                        })
                        
                        # 更新统计信息
                        stats["total"] += 1
                        stats["levels"][level] = stats["levels"].get(level, 0) + 1
                        if is_leaf:
                            stats["leaf_count"] += 1
    
    # 如果没有v2数据，使用cats（旧版数据）
    elif "cats" in official_data and official_data["cats"]:
        for cat_item in official_data["cats"]:
            if "cat_and_qua" in cat_item:
                for cat_info in cat_item["cat_and_qua"]:
                    if "cat" in cat_info:
                        cat = cat_info["cat"]
                        cat_id = cat.get("cat_id")
                        name = cat.get("name")
                        parent_id = cat.get("f_cat_id", 0)
                        level = cat.get("level", 1)
                        
                        categories.append({
                            "id": cat_id,
                            "name": name,
                            "parent_id": parent_id,
                            "level": level,
                            "source": "v1"
                        })
                        
                        # 更新统计信息
                        stats["total"] += 1
                        stats["levels"][level] = stats["levels"].get(level, 0) + 1
    
    return categories, stats
```

## 4. 商品类目使用规范

### 4.1 商品上传中的类目使用

在视频号小店商品上传时，`category_id`字段必须填写正确的类目ID：

```python
# 商品上传示例
product_params = {
    "product_base": {
        "title": "商品标题",
        "category_id": "1001",  # 必须使用叶子类目ID
        "brand_id": "1",
        # 其他必填字段...
    },
    # 其他商品信息...
}
```

### 4.2 类目选择原则

1. **必须选择叶子类目**：商品必须选择最底层的叶子类目（`leaf=true`）
2. **类目匹配度**：选择与商品性质最匹配的类目
3. **避免类目滥用**：不得为了规避审核或提高曝光而选择不相关类目
4. **多级类目确认**：确保了解完整的类目层级关系，选择正确的末级分类

### 4.3 资质要求处理

部分类目可能需要特殊资质，API返回的`qua`和`product_qua_list`字段包含相关要求：

```python
# 检查类目资质要求示例
def check_category_qualifications(official_data, cat_id):
    """
    检查指定类目是否需要特殊资质
    :param official_data: 官方返回的类目数据
    :param cat_id: 要检查的类目ID
    :return: 资质要求信息
    """
    qualification_info = {
        "need_to_apply": False,
        "mandatory": False,
        "tips": "",
        "certificate_required": []
    }
    
    # 优先检查cats_v2
    if "cats_v2" in official_data:
        for cat_item in official_data["cats_v2"]:
            for cat_info in cat_item["cat_and_qua"]:
                if cat_info["cat"].get("cat_id") == cat_id:
                    if "qua" in cat_info:
                        qua = cat_info["qua"]
                        qualification_info["need_to_apply"] = qua.get("need_to_apply", False)
                        qualification_info["mandatory"] = qua.get("mandatory", False)
                        qualification_info["tips"] = qua.get("tips", "")
                        
                        # 获取所需证照列表
                        if "cert_group_list" in qua:
                            for cert_group in qua["cert_group_list"]:
                                if cert_group.get("is_necessary") == 1:  # 必填证照
                                    qualification_info["certificate_required"].append({
                                        "group_id": cert_group.get("license_group_id"),
                                        "description": cert_group.get("busi_license_desc", "")
                                    })
                    return qualification_info
    
    return qualification_info
```

## 5. 常见问题与解决方案

### 5.1 API调用失败问题

| 错误码 | 可能原因 | 解决方案 |
|-------|---------|--------|
| 40066 | invalid url | 检查API路径是否正确，确认使用`/channels/ec/category/all` |
| 40001 | invalid credential | 检查access_token是否有效或过期 |
| 47001 | data format error | 确保请求格式正确，此接口不需要请求体 |
| 85060 | access denied | 确认账号已开通视频号小店功能且有权限 |

### 5.2 类目选择常见问题

1. **找不到合适类目**：选择最接近的叶子类目，避免使用过于宽泛的上级类目
2. **类目资质不符**：提前了解并准备相关资质证明材料
3. **类目ID错误**：使用官方API获取最新、正确的类目ID
4. **类目层级错误**：确保选择的是叶子类目，而非中间层级类目

### 5.3 access_token相关问题

**Q: 为什么一直提示access_token无效？**
A: 请确认以下几点：
- appid和appsecret是否正确
- 公众号是否已通过认证
- 是否有调用该API的权限
- 网络是否可以正常访问微信服务器

**Q: access_token多久需要更新一次？**
A: 微信access_token有效期为2小时（7200秒），WeChatShopAPIClient类会自动管理access_token的更新，无需手动操作。

**Q: 如何查看access_token是否成功获取？**
A: 可以在日志文件中查看access_token的获取情况，或使用test_category_access_token.py测试脚本进行验证。

## 6. 最佳实践

1. **定期更新类目数据**：建议每周获取一次最新类目数据，保持与平台同步
2. **建立类目映射表**：将常用类目ID和名称保存为本地映射表，提高开发效率
3. **分类测试机制**：在正式环境前，对不同类目进行上传测试，确保兼容性
4. **错误处理机制**：实现完善的错误重试和日志记录机制
5. **使用示例数据**：开发阶段可使用`wechat_shop_category_examples.json`中的示例数据

## 7. 测试与调试工具

### 7.1 官方提供的工具

- [微信开发者工具](https://developers.weixin.qq.com/miniprogram/en/dev/devtools/download.html)：可用于API调试
- [公众平台接口调试工具](https://mp.weixin.qq.com/debug/)：在线测试API接口

### 7.2 本地测试脚本

项目中提供的测试脚本：

1. **test_get_all_category.py**：专门测试官方标准类目API
2. **test_get_category.py**：兼容测试传统和视频号类目API

使用方法：
```bash
python test_get_all_category.py
```

## 8. 更新日志

- **2024-06-15**：基于官方最新文档重写，完全匹配标准API
- **2024-06-14**：增加cats_v2新版类目树说明
- **2024-06-13**：添加详细的字段说明和错误码处理

---

**注意**：本文档基于微信官方文档编写，如遇API变更，请以[官方文档](https://developers.weixin.qq.com/doc/store/shop/API/channels-shop-category/api_getallcategory.html)为准。