# 火山大模型图片生成集成 - 共识文档

## 明确的需求描述

### 核心需求
1. **火山大模型图片生成功能**：
   - 调用火山大模型API根据用户输入的商品描述生成图片
   - 生成3张不同角度或风格的商品主图
   - 生成2张展示商品细节或使用场景的详情图
   - 确保生成的图片符合微信小店的要求（格式、尺寸、大小等）

2. **与商品上传流程集成**：
   - 在商品上传前自动调用图片生成功能
   - 将生成的图片上传到微信小店获取URL
   - 将图片URL自动添加到商品数据结构中
   - 提供完整的端到端流程：输入商品描述 → 生成图片 → 上传图片 → 添加商品

## 技术实现方案

### 1. 火山大模型调用模块

#### 实现方式
- 创建独立的 `volcano_image_generator.py` 模块
- 使用HTTP请求调用火山大模型API
- 实现API密钥管理和错误处理

#### 关键组件
- `VolcanoImageGenerator` 类：负责与火山大模型API交互
- 配置管理：从环境变量或配置文件读取API密钥
- 重试机制：处理网络异常和API限流

### 2. 图片生成与管理功能

#### 实现方式
- 在本地创建临时目录存储生成的图片
- 实现图片格式和大小验证
- 提供图片生成日志和状态跟踪

#### 关键组件
- 图片生成请求构建器：根据输入内容生成合适的提示词
- 图片保存管理器：负责图片的本地存储和管理
- 图片验证器：检查图片是否符合微信小店要求

### 3. 与商品上传流程集成

#### 实现方式
- 修改现有的 `product_uploader.py` 或创建新的集成类
- 在商品上传前添加图片生成步骤
- 重用现有的图片上传和商品添加功能

#### 关键组件
- `ProductWithImageGenerator` 类：集成图片生成和商品上传功能
- 流程协调器：管理整个工作流程
- 错误处理和回滚机制

## 技术约束和集成方案

### 1. 技术约束

- **API限制**：需遵守火山大模型API的调用频率和并发限制
- **图片要求**：生成的图片必须符合微信小店要求
  - 格式：JPG、PNG
  - 尺寸：主图建议800x800像素
  - 大小：不超过1MB
- **性能考虑**：图片生成可能需要一定时间，需考虑异步处理

### 2. 集成方案

- **配置管理**：
  - 使用.env文件存储火山大模型API密钥
  - 在配置文件中添加图片生成相关参数

- **工作流程**：
  1. 用户输入商品描述和基本信息
  2. 系统调用火山大模型生成图片
  3. 系统将生成的图片上传到微信小店
  4. 系统将获取的图片URL添加到商品数据中
  5. 系统上传商品到微信小店

- **与现有系统集成**：
  - 重用 `wechat_shop_api.py` 中的 `upload_image` 方法
  - 重用商品上传相关功能
  - 提供独立的命令行接口和编程接口

## 任务边界限制

### 1. 功能边界

- **仅支持图片生成**：不包括复杂的图片编辑和后处理
- **不修改微信小店API**：只扩展现有功能，不修改核心API调用逻辑
- **基础错误处理**：提供基本的错误处理和日志记录

### 2. 非支持范围

- 不负责火山大模型API密钥的申请和管理
- 不保证生成图片的质量和准确性
- 不支持批量图片生成的高级优化
- 不提供复杂的用户界面

## 验收标准

### 1. 功能验收

- 能够成功调用火山大模型API生成图片
- 能够生成3张主图和2张详情图
- 生成的图片符合微信小店的要求
- 能够将生成的图片上传到微信小店并获取URL
- 能够将图片URL添加到商品数据中
- 能够成功上传包含生成图片的商品到微信小店

### 2. 技术验收

- 代码符合Python编码规范
- 提供完整的错误处理和异常捕获
- 实现日志记录功能
- 提供配置文件和环境变量支持
- 代码包含适当的注释和文档

### 3. 文档验收

- 提供详细的架构设计文档
- 提供完整的实现说明
- 提供使用指南和示例
- 提供配置说明

## 确认事项

1. 火山大模型API的具体参数和返回格式将在实现过程中根据实际API文档调整
2. 图片生成的具体提示词策略将根据实际效果进行优化
3. 所有敏感信息（如API密钥）将存储在环境变量或配置文件中，不硬编码在代码中
4. 实现将遵循项目现有的代码风格和架构模式